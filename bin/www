#!/usr/bin/env node
var debug = require('debug')('meanreader');
var app = require('../app');

var server = require('http').Server(app);
server.listen(process.env.PORT || 3000);

var io = require('socket.io')(server);

var Watcher = require('rss-watcher');
var feedCollection = [
  { xml: 'http://podcasts.engadget.com/rss.xml', name: 'engadget' },
  { xml: 'http://feeds.feedburner.com/TechCrunch/', name: 'techcrunch' },
  { xml: 'http://api.ihackernews.com/page?format=xml', name: 'hackernews' }
]
var watchers = []
feedCollection.forEach(function(data) {
  var item = { watcher: new Watcher(data.xml), name: data.name }
  watchers.push(item);
})
watchers.forEach(function(data) {
  data.watcher.on('new article', function(article) {
    io.sockets.emit(data.name, article);
  });

  // data.watcher.run(function(err, articles) {
  //   if (err)
  //     console.log(err);
  //   io.sockets.emit(data.name, articles);
  // });

  data.watcher.on('stop', function() {
    console.log('feed stopped.');
  });
  console.log(data);
});
